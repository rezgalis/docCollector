name: Version Bump & Release

on:
  push:
    branches:
      - master

jobs:
  release:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump level
        id: bump_level
        run: |
          # Find the latest tag, or use root commit if no tags exist
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, scanning all commits"
            COMMITS=$(git log --pretty=%s)
          else
            echo "Last tag: $LAST_TAG"
            COMMITS=$(git log "${LAST_TAG}..HEAD" --pretty=%s)
          fi

          echo "Commits since last tag:"
          echo "$COMMITS"

          # Default to patch
          BUMP="patch"

          # Check for feat: -> minor
          if echo "$COMMITS" | grep -qE '^feat(\(.+\))?:'; then
            BUMP="minor"
          fi

          # Check for feat!: or BREAKING CHANGE -> major (highest priority)
          if echo "$COMMITS" | grep -qE '^[a-z]+(\(.+\))?!:|BREAKING CHANGE'; then
            BUMP="major"
          fi

          echo "Bump level: $BUMP"
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"

      - name: Bump version in manifest.json
        id: version
        run: |
          CURRENT_VERSION=$(jq -r '.version' manifest.json)
          echo "Current version: $CURRENT_VERSION"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          BUMP="${{ steps.bump_level.outputs.bump }}"

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION ($BUMP bump)"

          jq --arg v "$NEW_VERSION" '.version = $v' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]"
          git push

      - name: Create release zip
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          ZIP_NAME="docCollector-${TAG}.zip"

          zip -r "${ZIP_NAME}" \
            manifest.json \
            README.md \
            src/ \
            icons/icon-16.png \
            icons/icon-48.png \
            icons/icon-128.png

          echo "Created ${ZIP_NAME}"
          ls -lh "${ZIP_NAME}"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_ENV"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: docCollector ${{ steps.version.outputs.tag }}
          body: |
            ## docCollector ${{ steps.version.outputs.tag }}

            Download `${{ env.zip_name }}` below, then load it in Chrome:

            1. Unzip the file
            2. Open `chrome://extensions/`
            3. Enable **Developer mode** (top right)
            4. Click **Load unpacked** and select the unzipped folder
          files: ${{ env.zip_name }}
          generate_release_notes: true
